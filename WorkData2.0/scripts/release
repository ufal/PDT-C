#!/bin/bash
set -eu -o pipefail
shopt -s extglob

target_dir=$PWD
mrp_dir=/net/work/people/zeman/mrp-data/mrp-pdtc20

dir=$(readlink -f "${0%/*}/..")
cd "$dir"

tmp=$(mktemp -d)
pdtc20="$tmp"/PDT-C-2.0
mkdir "$pdtc20"

pdtsc20="$dir"/../publication/PDTSC-2.0/data
workdata10="$dir"/../WorkData

find .  -name '*.[amtw]' \
     -o -name '*.[zwm]data' \
     -o -name 'pdtvallex-4.5.xml' \
    | while read file ; do
    path=${file%/*}
    if [[ ! -d $pdtc20/$path ]] ; then
        mkdir -p "$pdtc20/$path"
        mkdir -p "$pdtc20/${path/pml/treex}"
        if [[ $path != */pml/[am]* ]] ; then
            mkdir -p "$pdtc20/${path/pml/mrp}"
        fi
    fi
    cp "$file" "$pdtc20/$path"
    basename=${file##*/}
    ls "$pdtc20/$path/$basename"
    if [[ $file = *.m ]] ; then
        cp "${file%.m}".treex.gz "$pdtc20/${path/pml/treex}"
        ls "$pdtc20/${path/pml/treex}"/"${basename%.m}".treex.gz
    elif [[ $file = *.t ]] ; then
        if [[ $path = */PDT/* ]] ; then
            src="$mrp_dir"/"${path/\/pml\/tamw}"/"${basename%.t}".mrp
        else
            src="$mrp_dir"/"${path/\/pml*}"/"${basename%.t}".mrp
        fi
        cp  "$src" "$pdtc20/${path/pml/mrp}"
        ls "$pdtc20/${path/pml/mrp}"/"${basename%.t}".mrp
    elif [[ $file = *.mdata ]] ; then
        doc=${basename%_?.mdata}
        for v in 1 2 3 ; do
            if [[ "$doc"_$v.mdata != $basename && -f "$workdata10"/PDTSC/data/"$doc"_$v.mdata ]] ; then
                cp  "$workdata10"/PDTSC/data/"$doc"_$v.mdata "$pdtc20/$path"
                ls "$pdtc20/$path"/"$doc"_$v.mdata
            fi
        done
        [[ -d "$pdtc20"/${path/pml/ogg} ]] || mkdir -p "$pdtc20"/"${path/pml/ogg}"
        cp "$pdtsc20"/"$doc".ogg "$pdtc20"/"${path/pml/ogg}"
        ls "$pdtc20"/"${path/pml/ogg}"/$doc.ogg
    fi
done

mkdir "$pdtc20/resources"
cp "$dir"/../tred-extension/pdtc10/resources/*schema.xml "$pdtc20"/resources/
ls "$pdtc20"/resources/

cp "$dir"/../vallex.changes "$pdtc20"/dictionaries/
ls "$pdtc20"/dictionaries/vallex.changes

cp "$dir"/../pdtsc.map "$pdtc20"/PDTSC/
ls "$pdtc20"/PDTSC/pdtsc.map

cp "$dir"/README.txt "$pdtc20"/
ls "$pdtc20"/README.txt

cd "$tmp"
tar -f "$target_dir"/pdtc20.tgz -cz PDT-C-2.0
rm -rf "$tmp"
